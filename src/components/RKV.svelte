<script lang="ts">
	import {
		tokens,
		modelMeta,
		timemixHeadIdx, // =1
		vectorHeight,
		blockIdx
	} from '~/store';
	import classNames from 'classnames';
	import { onMount } from 'svelte';
	import VectorCanvas from './common/VectorCanvas.svelte';
	import OperationGroup from './OperationGroup.svelte';
	import { Tooltip } from 'flowbite-svelte';

	export let className: string | undefined = undefined;

	const embeddingVectorColor = 'bg-gray-300';

	let vectorHoverIdx: number | null = null;
	const receptanceVectorColor = 'bg-blue-200';
	const keyVectorColor = 'bg-red-200';
	const valVectorColor = 'bg-green-200';

	const receptanceHeadVectorColor = 'bg-blue-300';
	const keyHeadVectorColor = 'bg-red-300';
	const valHeadVectorColor = 'bg-green-300';

	// timemixHeadIdx subscribe
	const headCursors = {};

	onMount(() => {
		const unsubscribe = timemixHeadIdx.subscribe(async (newIdx) => {
			Object.values(headCursors).forEach((el) => {
				el.style.top = `${($vectorHeight / $modelMeta.timemix_head_num) * newIdx}px`;
			});
		});

		return () => {
			unsubscribe();
		};
	});
</script>

<div class={classNames('rkv', className)} role="none" data-click="rkv-step">
	<div class="content relative">
		<div
			class="vector-column block-start-column relative flex"
			class:initial-column={$blockIdx === 0}
		>
			<div class="column vectors embedding-column">
				{#each $tokens as token, index}
					<div
						class={`vector ${$blockIdx !== 0 ? 'bg-blue-200' : embeddingVectorColor}`}
						class:last={index === $tokens.length - 1}
					>
						<VectorCanvas colorScale={$blockIdx !== 0 ? 'blue' : 'gray'} />
					</div>
					<Tooltip placement="right" class="popover">vector({$modelMeta.dimension})</Tooltip>
				{/each}
			</div>
			<div class="operations flex">
				<OperationGroup type="residual-start" id={'embedding-residual'} />
				<OperationGroup type="ln" id={'embedding-ln'} />
			</div>
		</div>
		<div class="column rkv-column">
			{#each $tokens as token, index}
				<div
					class="rkv-weighted vector x3 flex flex-col"
					class:last={index === $tokens.length - 1}
					on:mouseenter={() => {
						vectorHoverIdx = index;
					}}
					on:mouseleave={() => {
						vectorHoverIdx = null;
					}}
					role="group"
				>
					<div class={`sub-vector receptance relative flex grow flex-col ${receptanceVectorColor}`}>
						<VectorCanvas colorScale="blue" active={vectorHoverIdx === index} />
						<div
							class={`sub-vector x1-12 head1 ${receptanceHeadVectorColor} absolute`}
							bind:this={headCursors[`token${index}_receptance`]}
						></div>
						<div class="sub-vector head-rest">
							{#if vectorHoverIdx !== index}<span>R</span>{/if}
						</div>
					</div>
					<div class={`sub-vector key relative flex grow flex-col ${keyVectorColor}`}>
						<VectorCanvas colorScale="red" active={vectorHoverIdx === index} />
						<div
							class={`sub-vector x1-12 head1 ${keyHeadVectorColor} absolute`}
							bind:this={headCursors[`token${index}_key`]}
						></div>
						<div class="sub-vector head-rest">
							{#if vectorHoverIdx !== index}<span>K</span>{/if}
						</div>
					</div>
					<div class={`sub-vector value relative flex grow flex-col ${valVectorColor}`}>
						<VectorCanvas colorScale="green" active={vectorHoverIdx === index} />
						<div
							class={`sub-vector x1-12 head1 ${valHeadVectorColor} absolute`}
							bind:this={headCursors[`token${index}_value`]}
						></div>
						<div class="sub-vector head-rest">
							{#if vectorHoverIdx !== index}<span>V</span>{/if}
						</div>
					</div>
				</div>
				<Tooltip placement="right" class="popover">vector({$modelMeta.dimension * 3})</Tooltip>
			{/each}
		</div>
	</div>
</div>

<style lang="scss">
	.rkv {
		.content {
			display: grid;
			grid-template-columns: 1fr 1fr;

			.vector-column {
				position: relative;
				left: 3rem;

				&.initial-column {
					left: -12px;
				}
			}
			.rkv-column {
				position: relative;
				left: 12px;
				display: flex;
				flex-direction: column;
				align-items: end;

				&.hide {
					pointer-events: none;
					opacity: 0.2;
				}
				.sub-vector {
					user-select: none;
					font-size: 0.8rem;
					span {
						opacity: 0.2;
					}
					&.receptance {
						color: theme('colors.blue.500');
					}
					&.key {
						color: theme('colors.red.500');
					}
					&.value {
						color: theme('colors.green.500');
					}

					.head-rest {
						height: 100%;
						display: flex;
						justify-content: center;
						align-items: center;
						font-weight: 700;
						text-shadow:
							-1px -1px 0 white,
							1px -1px 0 white,
							-1px 1px 0 white,
							1px 1px 0 white;
					}
				}
			}
		}

		&.animate-forward {
			.vector-column {
				transition-delay: 900ms;
				transition: left 100ms;
			}
		}
	}
</style>
